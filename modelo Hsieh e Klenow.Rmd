---
title: "Modelo do Hsieh e Klenow (2009)"
author: "Denise Manfredini"
date: "abril de 2019"
output:  pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



## Pacotes
```{r}
#install.packages("dplyr", repos = "http://cran.r-project.org")
library(tidyverse)
library(ggthemes, ggplot2)
```

# Importa os dados
```{r}
library(haven)
dados <- read_dta("C:/Users/Denise Manfredini/Downloads/[Manfredini]_artigo_microeconometria/[Manfredini]_artigo_microeconometria/base_dados_brutos.dta")

dados  <- dados  %>% filter(a0==1)
dim(dados)
```



## Gera os dados de capital, trabalho e valor adicionado

```{r}
dados <- mutate(dados,
                    K = n7a, #capital
                    L = n2a, #trabalho
                    Q = n2e, #insumo intermediário
                    C = n2e, #custo
                    PY = d2 - C #valor adicionado
                    ) 
dados %>%  select(K, L, Q, C, PY) %>%  head
```

# Cria indicador de setor
```{r}
dados$setor <- dados %>% group_indices(a4a)

```

## Seleciona as colunas

```{r}
#colnames(dados)

# se colocar um menos na frente a coluna é excluída
dados_select <- dados %>% select(K,L,Q,PY, setor)
```

# Confere os dados
```{r}
head(dados_select, 3)
dim(dados_select)
```


# Exclui NA
```{r}
dados_select <- dados_select %>% drop_na()


dim(dados_select)
head(dados_select)
```
# Exclui outros indicadores de ausência
```{r}

dados_select <- dados_select %>% filter(!((K==-9 | L==-9 | Q==-9| PY==-9))) 
dados_select <- dados_select %>% filter(!((K==0 | L==0|Q==-9| PY==0)))
dados_select <- dados_select %>% filter(!((K<=0 | L<=0 | Q<=0| PY<=0)))
dim(dados_select)
head(dados_select)
```
# Parâmetros calibrados
```{r}
Z <- 1
r <- 0.05
delta <- 0.05
sigma <- 3
R <- delta+r
W <- 1
```


#Médias setoriais
```{r}
dados_setor <- dados_select %>% count(setor) %>% 
             group_by(setor) %>% summarise_all(list(mean))

M_f <- dados_select %>% count(setor)

dados_setor <-inner_join(dados_setor, M_f, by="setor")
  
dados_setor <- rename(dados_setor, K_s = K, L_s=L, Q_s =Q, PY_s=PY, M=n) 

dados_setor %>% print %>% select(setor, K_s, L_s, Q_s, PY_s, M)
```

# mudar BEA
```{r}
dados_setor <- dados_setor %>% mutate(alpha_s= L_s/PY_s, beta_s = K_s/PY_s) #MUDAR

dados_setor %>% head

dados_select <-inner_join(dados_select, dados_setor, by="setor")

dados_setor<- dados_setor %>% filter(M>3)

dados_select %>% head
```
# Distorções individuais (si)
```{r}
tau_si<- dados_select %>% mutate(
  tau_k_si = ((alpha_s/(1-alpha_s-beta_s))*(Z*Q/R*K)), 
  tau_h_si = ((beta_s/(1-alpha_s-beta_s))*(Z*Q/W*L)),
  tau_y_si = ((sigma/(sigma-1))*(1/(1-alpha_s-beta_s))*(Z*Q/PY)),
  ) %>% select(setor, tau_k_si, tau_y_si, tau_h_si, K, Q, PY, L, beta_s, alpha_s, M)

tau_si  %>% head
```


# Distorções setoriais (s)
```{r}
tau_s<- dados_setor %>% group_by(setor) %>%  mutate(
  tau_k_s = (alpha_s/(1-alpha_s-beta_s))*(Z*Q_s/R*K_s), 
  tau_h_s = (beta_s/(1-alpha_s-beta_s))*(Z*Q_s/W*L_s),
  tau_y_s = (sigma/(sigma-1))*(1/(1-alpha_s-beta_s))*(Z*Q_s/PY_s),
  ) %>% select(tau_k_s, tau_y_s, tau_h_s, K_s, Q_s, PY_s, L_s, setor)

tau_s %>%  head
```

# distorções setoriais e individuais
```{r}
wedges <-inner_join(tau_si, tau_s, by="setor")

wedges %>% head

```
# TFPR padronizada
```{r}
wedges <- wedges %>% mutate(lnTFPR=alpha_s*log(tau_k_si/tau_k_s) + beta_s*log(tau_h_si/tau_h_s) - log(tau_y_si/tau_y_s))

wedges %>% head
wedges %>% dim
```


```{r}
A_si <- wedges %>% mutate(A = PY^(sigma/(sigma-1))) %>% select(setor, A, sigma, alpha_s, beta_s, M )

A_si <- A_si %>% mutate(M_sig = (M^(1/(sigma-1))))
                          
A_si <- A_si %>% group_by(setor) %>% 
    mutate(TFQ= (sum(A^(sigma-1)))^(1/(sigma-1))) %>% select(setor, TFQ,A,M_sig,TFQ)  %>%
   unnest


A_si <- A_si %>% mutate(lnTFQ = log(A*M_sig/TFQ)) %>% select (lnTFQ, setor)

A_si  <- A_si %>% drop_na()
head(A_si )
dim(A_si )
```
# Limpa TFPR
```{r}
wedges <- wedges %>% drop_na()
head(wedges)
dim(wedges)
```
# Exclui NA
```{r}

wedges <- wedges %>% drop_na()
head(wedges)
dim(wedges)
```
# Kernel Density Plot
```{r}
d <- density(wedges$lnTFPR) # returns the density data 
plot(d) # plots the results
```
# Kernel Density Plot
```{r}
b <- density(A_si$lnTFQ) # returns the density data 
plot(b) # plots the results
```

# Retirar valores no 1% das caudas

```{r}
wedges %>% dim

wedges <- wedges %>% filter(between(lnTFPR, quantile(lnTFPR, .01), quantile(lnTFPR, .99)))

wedges %>% dim
```

## Após remover 1% -- Recalcula todas médias setoriais
# wedges tem todas as informações

# vamos Recalcular todos os valores que são setorias
# i.e. K_s, Q_s, P_s, L_s, alpha_s, beta_s e tau_s
```{r}
wedges_si <- wedges %>% select(-K_s, -L_s, -Q_s, -PY_s, -alpha_s, -beta_s, - tau_h_s, - tau_k_s, -tau_y_s, -lnTFPR)

wedges %>% dim
```

# recalculando os insumo
```{r}
wedges_setor <- wedges_si %>% group_by(setor) %>% summarise_all(list(mean))

wedges_setor <- rename(wedges_setor, K_s = K, L_s=L, Q_s =Q, PY_s=PY) 

wedges_setor <- wedges_setor %>% select(setor, K_s, L_s, Q_s, PY_s)
```

# Recaculando alpha e beta
# mudar BEA
```{r}
wedges_setor <- wedges_setor %>% mutate(alpha_s= L_s/PY_s, beta_s = K_s/PY_s) #MUDAR

wedges_setor %>% head
```
# Mudar as distorções setoriais
# Distorções setoriais (s)
```{r}
tau_s<- wedges_setor %>% group_by(setor) %>%  mutate(
  tau_k_s = (alpha_s/(1-alpha_s-beta_s))*(Z*Q_s/R*K_s), 
  tau_h_s = (beta_s/(1-alpha_s-beta_s))*(Z*Q_s/W*L_s),
  tau_y_s = (sigma/(sigma-1))*(1/(1-alpha_s-beta_s))*(Z*Q_s/PY_s)
  ) %>% select(tau_k_s, tau_y_s, tau_h_s, setor)

tau_s %>%  head
```
# une os dados setoriais e os individuais
```{r}
wedges_final <-inner_join(wedges_si, tau_s, by="setor")
wedges_final <-inner_join(wedges_final, wedges_setor, by="setor")

wedges_final %>% head
wedges_final %>% dim
```

# Calcula as distorções TFPR

```{r}
wedges_final <- wedges_final %>% mutate(lnTFPR=alpha_s*log(tau_k_si/tau_k_s) + beta_s*log(tau_h_si/tau_h_s) - log(tau_y_si/tau_y_s))

wedges_final %>% head
wedges_final %>% dim
```

# Kernel Density Plot TFPR
```{r fig.width=7, fig.height=4, echo=FALSE}}

p  <- ggplot(wedges_final, aes(x=lnTFPR)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white")+
 geom_density(alpha=.2, fill="#CCCCCC") +
  xlab("lnTFPR") + ylab("Densidade") 
p  <- p + geom_density(alpha=0.55) +
  theme_pander() +
  scale_fill_grey() + theme_classic()
#+ coord_cartesian(xlim =c(-15, 05), ylim = c(0, 0.25))
p

```
# Quantis e Desvio-Padrão
```{r}
wedges_quartile <- wedges_final %>% 
  summarise(med = quantile(lnTFPR, probs = 0.50),
          prob25 = quantile(lnTFPR, probs = 0.025),
          prob75= quantile(lnTFPR, probs = 0.75),
          prob90= quantile(lnTFPR, probs = 0.90),
          prob10= quantile(lnTFPR, probs = 0.10),
                           SD = sd(lnTFPR),
          media = mean(lnTFPR),
          maximo = max(lnTFPR),
          minimo = min(lnTFPR))
wedges_quartile <- wedges_quartile %>% mutate(prob7525 = prob75-prob25,prob1090 = prob90-prob10)

wedges_quartile %>%
  select(SD, prob7525, prob1090, media, maximo, minimo) # reorder columns

```
# Quantis e Desvio-Padrão
```{r}
A_quartile <- A_si %>% 
  summarise(med = quantile(lnTFQ, probs = 0.50),
          prob25 = quantile(lnTFQ, probs = 0.025),
          prob75= quantile(lnTFQ, probs = 0.75),
          prob90= quantile(lnTFQ, probs = 0.90),
          prob10= quantile(lnTFQ, probs = 0.10),
                           SD = sd(lnTFQ),
          media = mean(lnTFQ),
          maximo = max(lnTFQ),
          minimo = min(lnTFQ))
A_quartile <- A_quartile %>% mutate(prob7525 = prob75-prob25,prob1090 = prob90-prob10)

A_quartile %>%
  select(SD, prob7525, prob1090, media, maximo, minimo) # reorder columns

```


# Kernel Density Plot TFPQ
```{r fig.width=7, fig.height=4, echo=FALSE}}

q  <- ggplot(A_si, aes(x=lnTFQ)) + 
 geom_histogram(aes(y=..density..), colour="black", fill="white")+
 geom_density(alpha=.2, fill="#d1c2c2") +
  xlab("lnTFPQ") + ylab("Densidade") 
q  <- q + geom_density(alpha=0.55) +
  theme_pander() +
  scale_fill_grey() + theme_classic() 
  #coord_cartesian(xlim =c(-15, 05), ylim = c(0, 0.25))
q

# Salva o gráfico em EPS
ggsave("q.eps", scale = 2)

```



